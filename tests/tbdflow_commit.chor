# ═══════════════════════════════════════════════════════════════════════════════
# tbdflow — Standardised Commits
# ═══════════════════════════════════════════════════════════════════════════════
# Validates that `tbdflow commit` produces conventional commits with the
# correct type, scope, message format, and breaking-change markers.
# ═══════════════════════════════════════════════════════════════════════════════

feature "tbdflow Standardised Commits"

actors: Terminal, FileSystem

settings {
    timeout_seconds = 30
    stop_on_failure = true
    shell_path = "/bin/bash"
}

# Each scenario gets its own isolated repo
var VALID_REPO = "/tmp/tbdflow_commit_valid"
var VALID_BARE = "/tmp/tbdflow_commit_valid_bare.git"
var INVALID_REPO = "/tmp/tbdflow_commit_invalid"
var INVALID_BARE = "/tmp/tbdflow_commit_invalid_bare.git"

# ─────────────────────────────────────────────────────────────────────────────
# Scenario 1 — Valid commits
# ─────────────────────────────────────────────────────────────────────────────

scenario "Creating valid conventional commits" {

    test Setup "Initialize test repository" {
        given:
            Test can_start
        when:
            Terminal run "rm -rf ${VALID_REPO} ${VALID_BARE} && mkdir -p ${VALID_REPO}"
            Terminal run "git init --bare ${VALID_BARE}"
            Terminal run "git -C ${VALID_REPO} init && git -C ${VALID_REPO} commit --allow-empty -m 'init'"
            Terminal run "git -C ${VALID_REPO} remote add origin ${VALID_BARE}"
            Terminal run "git -C ${VALID_REPO} push -u origin main"
            Terminal set_cwd "${VALID_REPO}"
        then:
            Terminal last_command succeeded
    }

    test SimpleFeat "Commit a simple feature" {
        given:
            Test has_succeeded Setup
        when:
            # tbdflow stages changes automatically; create a file first
            Terminal run "echo hello > new_feature.txt"
            Terminal run "tbdflow commit -t feat -m 'add user greeting'"
        then:
            Terminal last_command succeeded
            Terminal output_contains "Successfully committed"
            Terminal output_not_contains "Error"
    }

    test VerifyFeatCommit "The commit message follows conventional format" {
        given:
            Test has_succeeded SimpleFeat
        when:
            Terminal run "tbdflow sync"
        then:
            Terminal last_command succeeded
            Terminal output_contains "feat: add user greeting"
    }

    test ScopedFix "Commit a scoped fix" {
        given:
            Test has_succeeded VerifyFeatCommit
        when:
            Terminal run "echo patched > bugfix.txt"
            Terminal run "tbdflow commit -t fix -s auth -m 'resolve token expiry'"
        then:
            Terminal last_command succeeded
    }

    test VerifyScopedCommit "The scoped commit appears in the log" {
        given:
            Test has_succeeded ScopedFix
        when:
            Terminal run "tbdflow sync"
        then:
            Terminal last_command succeeded
            Terminal output_contains "fix(auth): resolve token expiry"
    }

    test BreakingChange "Commit with breaking change flag" {
        given:
            Test has_succeeded VerifyScopedCommit
        when:
            Terminal run "echo v2 > api.txt"
            Terminal run "tbdflow commit -t feat -s api -m 'remove legacy endpoint' -b"
        then:
            Terminal last_command succeeded
    }

    test CommitWithIssue "Commit referencing an issue key" {
        given:
            Test has_succeeded BreakingChange
        when:
            Terminal run "echo ticket_work > ticket.txt"
            Terminal run "tbdflow commit -t chore -m 'update dependencies' --issue PROJ-123"
        then:
            Terminal last_command succeeded
            Terminal output_not_contains "Error"
    }

    after {
        Terminal run "rm -rf ${VALID_REPO} ${VALID_BARE}"
    }
}

# ─────────────────────────────────────────────────────────────────────────────
# Scenario 2 — Invalid commits are rejected
# ─────────────────────────────────────────────────────────────────────────────

scenario "Rejecting invalid commit messages" {

    test Setup "Initialize test repository" {
        given:
            Test can_start
        when:
            Terminal run "rm -rf ${INVALID_REPO} ${INVALID_BARE} && mkdir -p ${INVALID_REPO}"
            Terminal run "git init --bare ${INVALID_BARE}"
            Terminal run "git -C ${INVALID_REPO} init && git -C ${INVALID_REPO} commit --allow-empty -m 'init'"
            Terminal run "git -C ${INVALID_REPO} remote add origin ${INVALID_BARE}"
            Terminal run "git -C ${INVALID_REPO} push -u origin main"
            Terminal set_cwd "${INVALID_REPO}"
        then:
            Terminal last_command succeeded
    }

    test InvalidType "Reject an unknown commit type" {
        given:
            Test has_succeeded Setup
        when:
            Terminal run "echo x > tmp.txt"
            Terminal run "tbdflow commit -t feature -m 'add something'"
        then:
            Terminal last_command failed
            Terminal output_not_contains "Successfully committed"
    }

    test CapitalisedMessage "Reject a message starting with a capital letter" {
        given:
            Test has_succeeded Setup
        when:
            Terminal run "echo x > tmp2.txt"
            Terminal run "tbdflow commit -t fix -m 'Fix the bug'"
        then:
            Terminal last_command failed
    }

    test TrailingPeriod "Reject a message ending with a period" {
        given:
            Test has_succeeded Setup
        when:
            Terminal run "echo x > tmp3.txt"
            Terminal run "tbdflow commit -t fix -m 'fix the bug.'"
        then:
            Terminal last_command failed
    }

    after {
        Terminal run "rm -rf ${INVALID_REPO} ${INVALID_BARE}"
    }
}
