# ═══════════════════════════════════════════════════════════════════════════════
# tbdflow — Branch Creation & Naming
# ═══════════════════════════════════════════════════════════════════════════════
# Validates that `tbdflow branch` creates short-lived branches with the
# correct naming conventions.
# ═══════════════════════════════════════════════════════════════════════════════

feature "tbdflow Branch Creation"

actors: Terminal, FileSystem

settings {
    timeout_seconds = 30
    stop_on_failure = true
    shell_path = "/bin/bash"
}

var REPO_DIR = "/tmp/tbdflow_branch_test"
var BARE_REPO = "/tmp/tbdflow_branch_bare.git"

# ─────────────────────────────────────────────────────────────────────────────
# Scenario — Branch creation workflows
# ─────────────────────────────────────────────────────────────────────────────

scenario "Creating short-lived branches" {

    test Setup "Initialize test repository" {
        given:
            Test can_start
        when:
            Terminal run "rm -rf ${REPO_DIR} ${BARE_REPO} && mkdir -p ${REPO_DIR}"
            Terminal run "git init --bare ${BARE_REPO}"
            Terminal run "git -C ${REPO_DIR} init && git -C ${REPO_DIR} commit --allow-empty -m 'init'"
            Terminal run "git -C ${REPO_DIR} remote add origin ${BARE_REPO}"
            Terminal run "git -C ${REPO_DIR} push -u origin main"
            Terminal set_cwd "${REPO_DIR}"
        then:
            Terminal last_command succeeded
    }

    test FeatBranch "Create a feature branch" {
        given:
            Test has_succeeded Setup
        when:
            Terminal run "tbdflow branch -t feat -n add-user-profile"
        then:
            Terminal last_command succeeded
            Terminal output_contains "feat/add-user-profile"
            Terminal output_not_contains "Error"
    }

    test FeatBranchVerify "Verify the branch exists in git" {
        given:
            Test has_succeeded FeatBranch
        when:
            Terminal run "git branch"
        then:
            Terminal last_command succeeded
            Terminal output_contains "feat/add-user-profile"
    }

    test BranchWithIssue "Create a branch with an issue key" {
        given:
            Test has_succeeded FeatBranchVerify
            # Return to main before creating a new branch
            Terminal run "git checkout main"
        when:
            Terminal run "tbdflow branch -t fix -n resolve-timeout --issue API-456"
        then:
            Terminal last_command succeeded
            Terminal output_contains "fix/API-456-resolve-timeout"
    }

    test VerifyIssueBranch "Verify the issue branch exists" {
        given:
            Test has_succeeded BranchWithIssue
        when:
            Terminal run "git branch"
        then:
            Terminal last_command succeeded
            Terminal output_contains "fix/API-456-resolve-timeout"
    }

    test ChoreBranch "Create a chore branch" {
        given:
            Test has_succeeded VerifyIssueBranch
            Terminal run "git checkout main"
        when:
            Terminal run "tbdflow branch -t chore -n update-deps"
        then:
            Terminal last_command succeeded
            Terminal output_contains "chore/update-deps"
    }

    after {
        Terminal run "rm -rf ${REPO_DIR} ${BARE_REPO}"
    }
}
