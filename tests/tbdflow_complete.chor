# ═══════════════════════════════════════════════════════════════════════════════
# tbdflow — Workflow Completion (merge & cleanup)
# ═══════════════════════════════════════════════════════════════════════════════
# Validates the full lifecycle: branch → commit → complete (merge back to main)
# ═══════════════════════════════════════════════════════════════════════════════

feature "tbdflow Workflow Completion"

actors: Terminal

settings {
    timeout_seconds = 30
    stop_on_failure = true
    shell_path = "/bin/bash"
}

var REPO_DIR = "/tmp/tbdflow_complete_test"
var BARE_REPO = "/tmp/tbdflow_complete_bare.git"

scenario "Full branch lifecycle: create, commit, complete" {

    test CompleteSetup "Initialize test repository" {
        given:
            Test can_start
        when:
            Terminal run "rm -rf ${REPO_DIR} ${BARE_REPO} && mkdir -p ${REPO_DIR}"
            Terminal run "git init --bare ${BARE_REPO}"
            Terminal run "git -C ${REPO_DIR} init && git -C ${REPO_DIR} commit --allow-empty -m 'init'"
            Terminal run "git -C ${REPO_DIR} remote add origin ${BARE_REPO}"
            Terminal run "git -C ${REPO_DIR} push -u origin main"
            Terminal set_cwd "${REPO_DIR}"
        then:
            Terminal last_command succeeded
    }

    test CreateBranch "Start a short-lived feature branch" {
        given:
            Test has_succeeded CompleteSetup
        when:
            Terminal run "tbdflow branch -t feat -n user-settings"
        then:
            Terminal last_command succeeded
            Terminal output_contains "feat/user-settings"
            Terminal output_not_contains "Error"
    }

    test CommitWork "Commit work on the branch" {
        given:
            Test has_succeeded CreateBranch
        when:
            Terminal run "echo settings_page > settings.txt"
            Terminal run "tbdflow commit -t feat -m 'add user settings page'"
        then:
            Terminal last_command succeeded
            Terminal output_not_contains "Error"
    }

    test CompleteWork "Merge the branch back to main" {
        given:
            Test has_succeeded CommitWork
        when:
            Terminal run "tbdflow complete -t feat -n user-settings"
        then:
            Terminal last_command succeeded
            Terminal output_contains "merged into main"
            Terminal output_contains "deleted"
    }

    test VerifyMergeOnMain "The commit exists on main after merge" {
        given:
            Test has_succeeded CompleteWork
        when:
            Terminal run "tbdflow sync"
        then:
            Terminal last_command succeeded
            Terminal output_contains "add user settings page"
            Terminal output_contains "On main branch"
    }

    test WorkingTreeClean "Working directory is clean after complete" {
        given:
            Test has_succeeded VerifyMergeOnMain
        when:
            Terminal run "tbdflow status"
        then:
            Terminal last_command succeeded
            Terminal output_contains "clean"
    }

    after {
        Terminal run "rm -rf ${REPO_DIR} ${BARE_REPO}"
    }
}
